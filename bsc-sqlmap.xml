<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="keyu.bsc">
	<select id="queryLabel" parameterType="java.util.Map"
		resultType="java.util.Map">
		select
			t.id,
			t.yppzwh,
			t1.yptymc,
			t1.yplb,
			t.bbh,
			t.zt,
			t.xglx,
			t.sjly,
			t.smsbblx,
			(select count(*) from cjpt_label t2 where t2.pid = t.id) child,
			(select t2.zt from cjpt_label t2 where t2.pid = t.id) childzt,
			t.thly
		from 
			cjpt_label t left join cjpt_jcsjxx t1 
			on t.yppzwh = t1.yppzwh
		where 1=1
		<if test="userId != null and userId != ''">
			and t.cjr = #{userId}
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh = #{yppzwh}
		</if>
		<if test="zt != null and zt != ''">
			and t.zt = #{zt}
		</if>
		order by t.bbh desc,decode(t.zt,'0',0,'1',1,'3',2,'2',3),t.cjsj desc
	</select>

	<select id="queryLabelCount" parameterType="java.util.Map"
		resultType="int">
		select 
			count(*)
		from 
			cjpt_label t
		where 1=1
		<if test="userId != null and userId != ''">
			and t.cjr = #{userId}
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh = #{yppzwh}
		</if>
		<if test="zt != null and zt != ''">
			and t.zt = #{zt}
		</if>
	</select>
	<!-- 变更信息查询 -->
	<select id="queryLabelBgxx" parameterType="java.util.Map"
		resultType="java.util.Map">
		select
			t.id,
			t.bgnr,
			t.bgh,
			t.bgq,
			t.lx,
			TO_CHAR(t.bgsj,'YYYY-MM-DD HH24:MI:SS') as bgsj
		from 
			cjpt_label_bgxx t 
		where 
			t.wj = #{wj} 
			and t.bgsj = (select MAX(t.bgsj) from cjpt_label_bgxx t where t.wj = #{wj})
	</select>

	<select id="queryLabelBgxxCount" parameterType="java.util.Map"
		resultType="int">
		select
			count(*)
		from 
			cjpt_label_bgxx t 
		where 
			t.wj = #{wj}
			and t.bgsj = (select MAX(t.bgsj) from cjpt_label_bgxx t where t.wj = #{wj})
	</select>
	<!-- 未确认记录数量 -->
	<select id="currentLabelStatus" parameterType="java.util.Map" resultType="int">
		select 
			count(*)
		from 
			cjpt_label t
		where 1=1 and t.zt != '2' and t.zt != '7'
			<if test="userId != null and userId != ''">
				and t.cjr = #{userId}
			</if>
			<if test="yppzwh != null and yppzwh != ''">
				and t.yppzwh = #{yppzwh}
			</if>
	</select>
	<!-- 查询状态不为废止的标签和说明书数量 -->
	<select id="queryLabelCountExceptFz" parameterType="java.util.Map"
		resultType="int">
		select 
			count(*)
		from 
			cjpt_label t
		where t.zt != '7'
		<if test="userId != null and userId != ''">
			and t.cjr = #{userId}
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh = #{yppzwh}
		</if>
	</select>
	
	<select id="queryAuditLabel" parameterType="java.util.Map"
		resultType="java.util.Map">
		select * from (
			select
				t.id,
				t.yppzwh,
				t1.yptymc,
				t2.qymc ypscqy,
				concat(t1.yplb,
					case 
						when((SELECT sc.sfym FROM cjpt_scgyxx sc WHERE sc.yppzwh = t.yppzwh and sc.jcxxzt = '1' ORDER BY sc.update_time DESC LIMIT 1 ) = '1') then '-疫苗'
						else ''
						end
				) yplb,
				t1.gg,
				t1.jx,
				t1.gcjkbs,
				t.bbh,
				t.smsbblx bblx,
				to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
				t.zt,
				TO_CHAR(t.tjrq,'YYYY-MM-DD HH24:MI:SS') as tjrq,
				t.thly,
				t.sjly,
				t.qyid,
				t.xglx
			from 
				cjpt_label t left join 
				cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				left join cjpt_qy t2 on t1.qyid = t2.id
			where t.zt = '1'
		) t where 1=1
		<if test="tsyh == null and xzqh != null and xzqh != ''">
			and t.qyid in (select q.id from cjpt_qy q where left(q.xzqh,2) = left(#{xzqh},2))
			and t.gcjkbs = '国产'
		</if>
		<if test="tsyh == null and xzqh == null or xzqh == ''">
			and t.gcjkbs = '进口'
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
		</if>
		<if test="yptymc != null and yptymc != ''">
			and t.yptymc like CONCAT('%',#{yptymc},'%' )
		</if>
		<if test="ypscqy != null and ypscqy != ''">
			and t.ypscqy like CONCAT('%',#{ypscqy},'%' )
		</if>
		<if test="yplb != null and yplb != ''">
			and t.yplb = #{yplb}
		</if>
		<!-- <if test="xglx != null and xglx != ''">
			and t.xglx = #{xglx}
		</if>
		<if test="xglx == null or xglx == ''">
			and (t.xglx is null or t.xglx = '4' or t.xglx = '')
		</if> -->
		order by t.tjrq desc
	</select>
	<!-- 标签和说明书采集审核列表 -->
	<select id="queryAuditLabelCount" parameterType="java.util.Map"
		resultType="int">
		select count(*) from(
			select 
				t.id,
				t.yppzwh,
				t1.yptymc,
				t2.qymc ypscqy,
				concat(t1.yplb,
					case 
						when((SELECT sc.sfym FROM cjpt_scgyxx sc WHERE sc.yppzwh = t.yppzwh and sc.jcxxzt = '1' ORDER BY sc.update_time DESC LIMIT 1 ) = '1') then '-疫苗'
						else ''
						end
				) yplb,
				t1.gg,
				t1.jx,
				t1.gcjkbs,
				t.bbh,
				t.zt,
				TO_CHAR(t.tjrq,'YYYY-MM-DD HH24:MI:SS') as tjrq,
				t.thly,
				t.qyid,
				t.xglx
			from 
				cjpt_label t left join 
				cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				left join cjpt_qy t2 on t1.qyid = t2.id
			where t.zt = '1'
		) t where 1=1
		<if test="tsyh == null and xzqh != null and xzqh != ''">
			and t.qyid in (select q.id from cjpt_qy q where left(q.xzqh,2) = left(#{xzqh},2))
			and t.gcjkbs = '国产'
		</if>
		<if test="tsyh == null and xzqh == null or xzqh == ''">
			and t.gcjkbs = '进口'
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
		</if>
		<if test="yptymc != null and yptymc != ''">
			and t.yptymc like CONCAT('%',#{yptymc},'%' )
		</if>
		<if test="ypscqy != null and ypscqy != ''">
			and t.ypscqy like CONCAT('%',#{ypscqy},'%' )
		</if>
		<if test="yplb != null and yplb != ''">
			and t.yplb = #{yplb}
		</if>
		<!-- <if test="xglx != null and xglx != ''">
			and t.xglx = #{xglx}
		</if>
		<if test="xglx == null or xglx == ''">
			and (t.xglx is null or t.xglx = '4' or t.xglx = '')
		</if> -->
	</select>
	
	<select id="queryAuditedLabel" parameterType="java.util.Map"
		resultType="java.util.Map">
		select * from (
			select
				t.id,
				t.yppzwh,
				t1.yptymc,
				t2.qymc ypscqy,
				concat(t1.yplb,
					case 
						when((SELECT sc.sfym FROM cjpt_scgyxx sc WHERE sc.yppzwh = t.yppzwh and sc.jcxxzt = '1' ORDER BY sc.update_time DESC LIMIT 1 ) = '1') then '-疫苗'
						else ''
						end
				) yplb,
				t1.gg,
				t1.jx,
				t1.gcjkbs,
				t.bbh,
				t.shr,
				TO_CHAR(t.shrq,'YYYY-MM-DD HH24:MI:SS') as shrq,
				t.smsbblx bblx,
				to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
				t.zt,
				TO_CHAR(t.tjrq,'YYYY-MM-DD HH24:MI:SS') as tjrq,
				t.thly,
				t.sjly,
				t.qyid,
				t.xglx
			from 
				cjpt_label t left join 
				cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				left join cjpt_qy t2 on t1.qyid = t2.id
			where t.zt = '2'
		) t where 1=1 and t.shr = #{userId}
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
		</if>
		<if test="yptymc != null and yptymc != ''">
			and t.yptymc like CONCAT('%',#{yptymc},'%' )
		</if>
		<if test="ypscqy != null and ypscqy != ''">
			and t.ypscqy like CONCAT('%',#{ypscqy},'%' )
		</if>
		<if test="yplb != null and yplb != ''">
			and t.yplb = #{yplb}
		</if>
		order by t.shrq desc
	</select>
	<!-- 标签和说明书采集审核列表 -->
	<select id="queryAuditedLabelCount" parameterType="java.util.Map"
		resultType="int">
		select count(*) from(
			select 
				t.id,
				t.yppzwh,
				t1.yptymc,
				t2.qymc ypscqy,
				concat(t1.yplb,
					case 
						when((SELECT sc.sfym FROM cjpt_scgyxx sc WHERE sc.yppzwh = t.yppzwh and sc.jcxxzt = '1' ORDER BY sc.update_time DESC LIMIT 1 ) = '1') then '-疫苗'
						else ''
						end
				) yplb,
				t1.gg,
				t1.jx,
				t1.gcjkbs,
				t.bbh,
				t.shr,
				t.shrq,
				t.zt,
				TO_CHAR(t.tjrq,'YYYY-MM-DD HH24:MI:SS') as tjrq,
				t.thly,
				t.qyid,
				t.xglx
			from 
				cjpt_label t left join 
				cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				left join cjpt_qy t2 on t1.qyid = t2.id
			where t.zt = '2'
		) t where 1=1 and t.shr = #{userId}
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
		</if>
		<if test="yptymc != null and yptymc != ''">
			and t.yptymc like CONCAT('%',#{yptymc},'%' )
		</if>
		<if test="ypscqy != null and ypscqy != ''">
			and t.ypscqy like CONCAT('%',#{ypscqy},'%' )
		</if>
		<if test="yplb != null and yplb != ''">
			and t.yplb = #{yplb}
		</if>
	</select>
	
	<select id="queryLabelByYppzwh" parameterType="java.util.Map"
		resultType="int">
		select 
			count(*)
		from 
			cjpt_label t 
		where t.zt = '2'
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh = #{yppzwh}
		</if>
		<if test="xglx != null and xglx != ''">
			and t.xglx = #{xglx}
		</if>
	</select>

	<select id="queryScgywdcyrzCount" parameterType="java.util.Map"
		resultType="int">
		select
			count(distinct(t1.id))
		from 
			cjpt_scgywdcyrz t1 
		where rzlx = '1'
		<if test="orgName != null and orgName != ''">
			and t1.cyjg = #{orgName}
		</if>
		<if test="qymc != null and qymc != ''">
			and t1.ssqy like '%${qymc}%'
		</if>
		<if test="staff != null and staff != ''">
			and t1.cyry like '%${staff}%'
		</if>
		<if test="pzwh != null and pzwh != ''">
			and t1.pzwh like '%${pzwh}%'
		</if>
		<if test="startTime != null and startTime != ''">
			and t1.cysj &gt;= date(#{startTime})
		</if>
		<if test="endTime != null and endTime != ''">
			and t1.cysj &lt; date_add(date(#{endTime}), '1 DAY')
		</if>
		<if test="status != null and status != ''">
			and t1.czlx = #{status}
		</if>
	</select>
	
	<!-- 生产工艺信息查询加载 -->
	<select id="queryScgyxx" parameterType="java.util.Map"
		resultType="java.util.Map">
			select 
				t.yppzwh yppzwh,
				t.yptymc yptymc,
				t.jx jx,
				t.gg gg,
				t.pzrq pzrq,
				concat(t.yplb,case
					when(t.sfym = '1') then '-疫苗'
					else ''
				end) yplb,
				t.zxsjly,
				t.zxlabelId,
				t.zxzt,
				t.labelId,
				case
					when(t.zt = '0') then '未提交'
					when(t.zt = '1') then '已提交'
					when(t.zt = '2') then '已审核'
					when(t.zt = '3') then '已退回'
					else ''
				end labelzt
			from(select 
					t.yppzwh yppzwh,
					t1.yptymc yptymc,
					t1.jx jx,
					t1.gg gg,
					to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
					t1.yplb yplb,
					t1.qyid,
					t.sfym,
					(select id from cjpt_label t2 where t2.yppzwh = t.yppzwh and t2.zt != '7' and t2.sjly = '企业填报' order by decode(t2.zt,'0',0,'1',1,'3',2,'2',3),t2.bbh desc,t2.xglx desc limit 1) labelId,
					(select zt from cjpt_label t2 where t2.yppzwh = t.yppzwh and t2.zt != '7' and t2.sjly = '企业填报' order by decode(t2.zt,'0',0,'1',1,'3',2,'2',3),t2.bbh desc,t2.xglx desc limit 1) zt,
					(select sjly from cjpt_label t2 where t2.yppzwh = t.yppzwh and t2.zt != '7' order by t2.bbh desc,t2.xglx desc,t2.sjly limit 1) zxsjly,
					(select id from cjpt_label t2 where t2.yppzwh = t.yppzwh and t2.zt != '7' order by t2.bbh desc,t2.xglx desc,t2.sjly limit 1) zxlabelId,
					(select zt from cjpt_label t2 where t2.yppzwh = t.yppzwh and t2.zt != '7' order by t2.bbh desc,t2.xglx desc,t2.sjly limit 1) zxzt
				from
					(select 
							* 
						from 
							(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.update_time
								from 
									cjpt_scgyxx sc 
								where 
								<!-- 列表目前只显示疫苗数据 和不是进口分包装且上市销售的-->
								sc.jcxxzt = '1' 
								and sfym = '1' 
								and sc.sfjkfbzxs = '0') t where t.rn = 1
					) t inner join cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				where 1=1
				<if test="yhlx ==1">
					and exists(
						select 1 from 
							cjpt_qyjcsjgxb b 
						where t1.qyid=b.qyid 
							and t1.jcsjid=b.yppjxxid 
							and zt=1
							and t1.qyid = #{qyid})
				</if>
				<if test="yhlx ==3">
					<if test="sfsqsypzwh ==1 ">
						and t1.qyid = #{qyid}
					</if>
					<if test="sfsqsypzwh ==null  or sfsqsypzwh ==0 or sfsqsypzwh =='' ">
						and t1.jcsjid in (Select x.yppjxxid from cjpt_yhbqgx x where
						x.yhid=#{userId} )
					</if>
				</if>
			) t where 1=1
				<if test="yppzwh !=null">
					and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
				</if>
				<if test="yptymc !=null">
					and t.yptymc like CONCAT('%',#{yptymc},'%' )
				</if>
				<if test="labelzt != null and labelzt != ''">
					and t.zt = #{labelzt }
				</if>
				<if test="yplb !=null">
					and t.yplb =#{yplb}
				</if>
			order by decode(nvl(t.zt,'') || nvl(t.zxsjly,''),
									'2数据对接',0,
									'数据对接',0,
									'',1,
									'0数据对接',2,
									'0企业填报',2,
									'1数据对接',3,
									'1企业填报',3,
									'3数据对接',4,
									'3企业填报',4,
									'2企业填报',5),t.pzrq desc
	</select>

	<select id="queryScgyxxCount" parameterType="java.util.Map"
		resultType="int">
		select count(s.yppzwh) 
		from (
			select 
				t.yppzwh yppzwh,
				t.yptymc yptymc,
				t.jx jx,
				t.gg gg,
				t.pzrq pzrq,
				concat(t.yplb,case
					when(t.sfym = '1') then '-疫苗'
					else ''
				end) yplb,
				case
					when(t.zt = '0') then '未提交'
					when(t.zt = '1') then '已提交'
					when(t.zt = '2') then '已审核'
					when(t.zt = '3') then '已退回'
					else ''
				end labelzt
			from(select 
					t.yppzwh yppzwh,
					t1.yptymc yptymc,
					t1.jx jx,
					t1.gg gg,
					to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
					t1.yplb yplb,
					t1.qyid,
					t.sfym,
					(select zt from cjpt_label t2 where t2.yppzwh = t.yppzwh and t2.zt != '7' and t2.sjly = '企业填报' order by decode(t2.zt,'0',0,'1',1,'3',2,'2',3),t2.bbh desc,t2.xglx desc limit 1) zt
				from
					(select 
							* 
						from 
							(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.update_time
								from 
									cjpt_scgyxx sc 
								where 
								<!-- 列表目前只显示疫苗数据 和不是进口分包装且上市销售的-->
								sc.jcxxzt = '1' 
								and sfym = '1' 
								and sc.sfjkfbzxs = '0') t where t.rn = 1
					) t inner join cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				where 1=1
				<if test="yhlx ==1">
					and exists(
						select 1 from 
							cjpt_qyjcsjgxb b 
						where t1.qyid=b.qyid 
							and t1.jcsjid=b.yppjxxid 
							and zt=1
							and t1.qyid = #{qyid})
				</if>
				<if test="yhlx ==3">
					<if test="sfsqsypzwh ==1 ">
						and t1.qyid = #{qyid}
					</if>
					<if test="sfsqsypzwh ==null  or sfsqsypzwh ==0 or sfsqsypzwh =='' ">
						and t1.jcsjid in (Select x.yppjxxid from cjpt_yhbqgx x where
						x.yhid=#{userId} )
					</if>
				</if>
			) t where 1=1
				<if test="yppzwh !=null">
					and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
				</if>
				<if test="yptymc !=null">
					and t.yptymc like CONCAT('%',#{yptymc},'%' )
				</if>
				<if test="labelzt != null and labelzt != ''">
					and t.zt = #{labelzt }
				</if>
				<if test="yplb !=null">
					and t.yplb =#{yplb}
				</if>
		) s where 1=1
	</select>
	<select id="queryCplb" parameterType="java.util.Map"
		resultType="java.util.Map">
		select 
			yplb
		from(
			select 
			  concat(jc.yplb,
					case 
						when((SELECT sc.sfym FROM cjpt_scgyxx sc WHERE sc.yppzwh = jc.yppzwh and sc.jcxxzt = '1' ORDER BY sc.update_time DESC LIMIT 1 ) = '1') then '-疫苗'
						else ''
						end
				) yplb
			from cjpt_jcsjxx jc where 1=1 and yplb is not null and yplb !=''
	
			<if test="yhlx ==1">
				and exists(
						select 1 from 
							cjpt_qyjcsjgxb b 
						where jc.qyid=b.qyid 
							and jc.jcsjid=b.yppjxxid 
							and zt=1
							and jc.qyid = #{qyid})
			</if>
			<if test="yhlx ==3">
				<if test="sfsqsypzwh ==1 ">
					and jc.qyid = #{qyid}
				</if>
				<if test="sfsqsypzwh ==null  or sfsqsypzwh ==0 or sfsqsypzwh =='' ">
					and jc.jcsjid in (Select x.yppjxxid from cjpt_yhypgx x where
					x.yhid=#{userId} )
				</if>
			</if>
		) t
		GROUP BY t.yplb
	</select>
	<delete id="deleteLabelbgxx" parameterType="java.util.Map">
		delete from cjpt_label_bgxx t where t.wj = #{labelId}
	</delete>
	<!-- 查询附件数据 -->
    <select id="getFileList" parameterType="java.util.Map" resultType="java.util.Map">
    	SELECT
    	  t.id AS id,
				TO_CHAR(t.scsj,'YYYY-MM-DD') as scsj,
				t.sczid ,
				t.sczxm,
				t.fjywjm,
				t.fjbclj,
				t.fjwjlx,
				ROUND(t.fjdx/1024/1024,2) || 'M' AS filesize,
				t.bz AS remark,
				TO_CHAR(t.hzrq,'YYYY-MM-DD') as hzrq,
				t.ywjlj
    	FROM cjpt_xtfj t, cjpt_xtfjdxgx b
			WHERE t.id = b.fjid
			 AND b.dxjlid = #{objId}
			 AND b.ly = #{lx}
		ORDER BY t.scsj desc
    </select>
    <select id="getFileCount" parameterType="java.util.Map"
		resultType="int">
		SELECT
    	  count(*)
    	FROM cjpt_xtfj t, cjpt_xtfjdxgx b
			WHERE t.id = b.fjid
			 AND b.dxjlid = #{objId}
			 AND b.ly = #{lx}
	</select>
	
	<!-- 标签和说明书监管查询 -->
	<select id="queryJgLabel" parameterType="java.util.Map"
		resultType="java.util.Map">
		select * from (
			select
				t.id,
				t.yppzwh,
				t1.qyid,
				t2.qymc ypscqy,
				t1.yptymc,
				concat(t1.yplb,decode(t3.sfym,'1','-疫苗')) yplb,
				t1.gg,
				t1.jx,
				t.bbh,
				to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
				t.smsbblx bblx,
				t3.sfym,
				t.zt,
				t.sjly,
				t.thly,
				t2.xzqh,
				t.xglx
			from 
				cjpt_label t inner join 
				cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				inner join cjpt_qy t2 on t1.qyid = t2.id
				inner join (select * from 
								(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.update_time
									from cjpt_scgyxx sc where sc.jcxxzt = '1' and sfym = '1') t where t.rn = 1) t3 on t.yppzwh = t3.yppzwh
			where t.zt = '2'
			<if test="cf != null and cf != ''">
				<!-- and t.cf like CONCAT('%',#{cf},'%' ) -->
				and regexp_like(t.cf,replace(replace(#{cf},chr(10),''),chr(13),'\n'))
			</if>
			<if test="syz != null and syz != ''">
				<!-- and t.syz like CONCAT('%',#{syz},'%' ) -->
				and regexp_like(t.syz,replace(replace(#{syz},chr(10),''),chr(13),'\n'))
			</if>
			<if test="sjly != null and sjly != ''">
				and t.sjly = #{sjly}
			</if>
			<if test="gnzz != null and gnzz != ''">
				<!-- and t.gnzz like CONCAT('%',#{gnzz},'%' ) -->
				and regexp_like(t.gnzz,replace(replace(#{gnzz},chr(10),''),chr(13),'\n'))
			</if>
		) t where t.sfym = '1' 
		<if test="xzqh != null and xzqh != ''">
			and left(t.xzqh,2) = left(#{xzqh},2)
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
		</if>
		<if test="yptymc != null and yptymc != ''">
			and t.yptymc like CONCAT('%',#{yptymc},'%' )
		</if>
		<if test="yplb != null and yplb != ''">
			and t.yplb = #{yplb}
		</if>
		<if test="ypscqy != null and ypscqy != ''">
			and t.ypscqy like CONCAT('%',#{ypscqy},'%' )
		</if>
		<if test="compId != null and compId != ''">
			and t.qyid = #{compId}
		</if>
		order by t.ypscqy,t.yppzwh,t.bbh desc
	</select>
	<select id="queryJgLabelCount" parameterType="java.util.Map"
		resultType="int">
		select count(*) from (
			select
				t.id,
				t.yppzwh,
				t1.qyid,
				t2.qymc ypscqy,
				t1.yptymc,
				concat(t1.yplb,decode(t3.sfym,'1','-疫苗')) yplb,
				t1.gg,
				t1.jx,
				t.bbh,
				to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
				t.smsbblx bblx,
				t3.sfym,
				t.zt,
				t.sjly,
				t.thly,
				t2.xzqh,
				t.xglx
			from 
				cjpt_label t inner join 
				cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
				inner join cjpt_qy t2 on t1.qyid = t2.id
				inner join (select * from 
								(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.update_time
									from cjpt_scgyxx sc where sc.jcxxzt = '1' and sfym = '1') t where t.rn = 1) t3 on t.yppzwh = t3.yppzwh
			where t.zt = '2'
			<if test="cf != null and cf != ''">
				<!-- and t.cf like CONCAT('%',#{cf},'%' ) -->
				and regexp_like(t.cf,replace(replace(#{cf},chr(10),''),chr(13),'\n'))
			</if>
			<if test="syz != null and syz != ''">
				<!-- and t.syz like CONCAT('%',#{syz},'%' ) -->
				and regexp_like(t.syz,replace(replace(#{syz},chr(10),''),chr(13),'\n'))
			</if>
			<if test="sjly != null and sjly != ''">
				and t.sjly = #{sjly}
			</if>
			<if test="gnzz != null and gnzz != ''">
				<!-- and t.gnzz like CONCAT('%',#{gnzz},'%' ) -->
				and regexp_like(t.gnzz,replace(replace(#{gnzz},chr(10),''),chr(13),'\n'))
			</if>
		) t where t.sfym = '1' 
		<if test="xzqh != null and xzqh != ''">
			and left(t.xzqh,2) = left(#{xzqh},2)
		</if>
		<if test="yppzwh != null and yppzwh != ''">
			and t.yppzwh like CONCAT('%',#{yppzwh},'%' )
		</if>
		<if test="yptymc != null and yptymc != ''">
			and t.yptymc like CONCAT('%',#{yptymc},'%' )
		</if>
		<if test="yplb != null and yplb != ''">
			and t.yplb = #{yplb}
		</if>
		<if test="ypscqy != null and ypscqy != ''">
			and t.ypscqy like CONCAT('%',#{ypscqy},'%' )
		</if>
		<if test="compId != null and compId != ''">
			and t.qyid = #{compId}
		</if>
	</select>
	<update id="setLabelFz" parameterType="java.util.Map">
		update 
			cjpt_label set zt = '7'
		where
			yppzwh = #{yppzwh}
	</update>
	
	<!-- 推送基础信息表有更新的内容 -->
	<select id="queryPushJcsjxx" parameterType="java.util.Map"
		resultType="com.keyu.scgy.vo.PushLabelVO">
		select 
			distinct t1.id,
			t.yppzwh,
			t.yptymc,
			t.ypmcywm,
			t.yplb,
			t.jx,
			t.gg,
			t.ssxkcyr,
			t.ssxkcyryw,
			t.ypscqy,
			t.qymc_en ypscqyyw,
			null fbzqymc,
			to_char(t.pzrq,'YYYY-MM-DD') as pzrq,
			to_char(t.yppzwhyxq,'YYYY-MM-DD') as yppzwhyxq,
			decode(t4.sfzc,'1','在产','0','不在产') sfzc,
			t4.sfym,
			t2.smsFjbclj,
			t2.smsFjywjm,
			t3.bqFjbclj,
			t3.bqFjywjm,
			t5.jbFjywjm,
			t5.jbFjbclj,
			t1.cf,
			t1.xz,
			t1.gnzz,
			t1.syz,
			t1.blfy,
			t1.yfyl,
			t1.jj,
			t1.zysx,
			t1.ywhxzy,
			t1.ylzy,
			t1.zc,
			t1.sfmh,
			t1.sfmy,
			t1.cfhxz,
			t1.jzdx,
			t1.zyyyt,
			t1.rsfnyy,
			t1.brqfnyy,
			t1.bz,
			decode(t.ypjcxxzt,'3','2','1','1','2','2','4','4') ypjcxxzt,
			to_char(t1.smspzbasj,'YYYY-MM-DD') as pzbarq,
			to_char(t.update_time,'yyyyMMdd') gxsj,
			t1.sjly,
			t1.pid,
			t1.xglx
		from cjpt_jcsjxx t inner join cjpt_label t1 on t.yppzwh = t1.yppzwh
		left join (select wm_concat(t4.fjbclj) smsFjbclj,wm_concat(t4.fjywjm) smsFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'smsWD' group by t3.dxjlid) t2 on t2.dxjlid = t1.id
		left join (select wm_concat(t4.fjbclj) bqFjbclj,wm_concat(t4.fjywjm) bqFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'bqWD' group by t3.dxjlid) t3 on t3.dxjlid = t1.id
		left join (select  wm_concat(t4.fjbclj) jbFjbclj, wm_concat(t4.fjywjm) jbFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'jbWD' group by t3.dxjlid) t5 on t5.dxjlid = t1.id
		left join (select * from 
								(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.sfzc,
									sc.update_time
									from cjpt_scgyxx sc) t where t.rn = 1) t4 on t.yppzwh = t4.yppzwh
		where t1.zt = '2' and t1.sjly = '企业填报'
		<if test="yesterday != null and yesterday != ''">
			and to_char(t.update_time,'yyyyMMdd') = #{yesterday} 
		</if>
	</select>
	<!-- 推送疫苗说明书和标签数据查询 -->
	<select id="queryPushLabel" parameterType="java.util.Map"
		resultType="com.keyu.scgy.vo.PushLabelVO">
		select
			distinct t.id,
			t.yppzwh,
			t1.yptymc,
			t1.ypmcywm,
			t1.yplb,
			t1.jx,
			t1.gg,
			t1.ssxkcyr,
			t1.ssxkcyryw,
			t1.ypscqy,
			t1.qymc_en ypscqyyw,
			null fbzqymc,
			to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
			to_char(t1.yppzwhyxq,'YYYY-MM-DD') as yppzwhyxq,
			decode(t4.sfzc,'1','在产','0','不在产') sfzc,
			t4.sfym,
			t2.smsFjbclj,
			t2.smsFjywjm,
			t3.bqFjbclj,
			t3.bqFjywjm,
			t5.jbFjywjm,
			t5.jbFjbclj,
			t.cf,
			t.xz,
			t.gnzz,
			t.syz,
			t.blfy,
			t.yfyl,
			t.jj,
			t.zysx,
			t.ywhxzy,
			t.ylzy,
			t.zc,
			t.sfmh,
			t.sfmy,
			t.cfhxz,
			t.jzdx,
			t.zyyyt,
			t.rsfnyy,
			t.brqfnyy,
			t.bz,
			decode(t1.ypjcxxzt,'3','2','1','1','2','2','4','4') ypjcxxzt,
			to_char(t.smspzbasj,'YYYY-MM-DD') as pzbarq,
			to_char(t1.update_time,'yyyyMMdd') gxsj,
			t.sjly,
			t.pid,
			t.xglx
		from 
			cjpt_label t 
			left join cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
			left join (select wm_concat(t4.fjbclj) smsFjbclj,wm_concat(t4.fjywjm) smsFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'smsWD' group by t3.dxjlid) t2 on t2.dxjlid = t.id
		left join (select wm_concat(t4.fjbclj) bqFjbclj,wm_concat(t4.fjywjm) bqFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'bqWD' group by t3.dxjlid) t3 on t3.dxjlid = t.id
		left join (select  wm_concat(t4.fjbclj) jbFjbclj, wm_concat(t4.fjywjm) jbFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'jbWD' group by t3.dxjlid) t5 on t5.dxjlid = t.id
		left join (select * from 
								(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.sfzc,
									sc.update_time
									from cjpt_scgyxx sc) t where t.rn = 1) t4 on t.yppzwh = t4.yppzwh
		where t.zt = '2' and t.sjly = '企业填报' and t.sjzt is null
	</select>
	
	<!-- 推送疫苗说明书和标签数据查询-数据对接 -->
	<select id="queryPushLabelSjdj" parameterType="java.util.Map"
		resultType="com.keyu.scgy.vo.PushLabelVO">
		select
			distinct t.id,
			t.yppzwh,
			t1.yptymc,
			t1.ypmcywm,
			t1.yplb,
			t1.jx,
			t1.gg,
			t1.ssxkcyr,
			t1.ssxkcyryw,
			t1.ypscqy,
			t1.qymc_en ypscqyyw,
			null fbzqymc,
			to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
			to_char(t1.yppzwhyxq,'YYYY-MM-DD') as yppzwhyxq,
			decode(t4.sfzc,'1','在产','0','不在产') sfzc,
			t4.sfym,
			t2.smsFjbclj,
			t2.smsFjywjm,
			t3.bqFjbclj,
			t3.bqFjywjm,
			t5.jbFjywjm,
			t5.jbFjbclj,
			t.cf,
			t.xz,
			t.gnzz,
			t.syz,
			t.blfy,
			t.yfyl,
			t.jj,
			t.zysx,
			t.ywhxzy,
			t.ylzy,
			t.zc,
			t.sfmh,
			t.sfmy,
			t.cfhxz,
			t.jzdx,
			t.zyyyt,
			t.rsfnyy,
			t.brqfnyy,
			t.bz,
			decode(t1.ypjcxxzt,'3','2','1','1','2','2','4','4') ypjcxxzt,
			to_char(t.smspzbasj,'YYYY-MM-DD') as pzbarq,
			to_char(t1.update_time,'yyyyMMdd') gxsj,
			t.sjly,
			t.pid,
			t.xglx
		from 
			cjpt_label t 
			left join cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
			left join (select wm_concat(t4.fjbclj) smsFjbclj,wm_concat(t4.fjywjm) smsFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'smsWD' group by t3.dxjlid) t2 on t2.dxjlid = t.id
		left join (select wm_concat(t4.fjbclj) bqFjbclj,wm_concat(t4.fjywjm) bqFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'bqWD' group by t3.dxjlid) t3 on t3.dxjlid = t.id
		left join (select  wm_concat(t4.fjbclj) jbFjbclj, wm_concat(t4.fjywjm) jbFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'jbWD' group by t3.dxjlid) t5 on t5.dxjlid = t.id
		left join (select * from 
								(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.sfzc,
									sc.update_time
									from cjpt_scgyxx sc) t where t.rn = 1) t4 on t.yppzwh = t4.yppzwh
		where t.zt = '2' and t.sjly = '数据对接' and t.sjzt is null and t.yppzwh not like '%-%' and t.yppzwh not like '%－%'
		union
			select 
			t.id,
			t.yppzwh,
			t.yptymc,
			t.ypmcywm,
			t.yplb,
			t.jx,
			t.gg,
			t.ssxkcyr,
			t.ssxkcyryw,
			t.ypscqy,
			t.ypscqyyw,
			t.fbzqymc,
			t.pzrq,
			t.yppzwhyxq,
			t.sfzc,
			t.sfym,
			t.smsFjbclj,
			t.smsFjywjm,
			t.bqFjbclj,
			t.bqFjywjm,
			t.jbFjywjm,
			t.jbFjbclj,
			t.cf,
			t.xz,
			t.gnzz,
			t.syz,
			t.blfy,
			t.yfyl,
			t.jj,
			t.zysx,
			t.ywhxzy,
			t.ylzy,
			t.zc,
			t.sfmh,
			t.sfmy,
			t.cfhxz,
			t.jzdx,
			t.zyyyt,
			t.rsfnyy,
			t.brqfnyy,
			t.bz,
			t.ypjcxxzt,
			t.pzbarq,
			t.gxsj,
			t.sjly,
			t.pid,
			t.xglx
		 from (
			select
			t.id,
			t.yppzwh,
			t1.yptymc,
			t1.ypmcywm,
			t1.yplb,
			t1.jx,
			t1.gg,
			t1.ssxkcyr,
			t1.ssxkcyryw,
			t1.ypscqy,
			t1.qymc_en ypscqyyw,
			null fbzqymc,
			to_char(t1.pzrq,'YYYY-MM-DD') as pzrq,
			to_char(t1.yppzwhyxq,'YYYY-MM-DD') as yppzwhyxq,
			decode(t4.sfzc,'1','在产','0','不在产') sfzc,
			t4.sfym,
			t2.smsFjbclj,
			t2.smsFjywjm,
			t3.bqFjbclj,
			t3.bqFjywjm,
			t5.jbFjywjm,
			t5.jbFjbclj,
			t.cf,
			t.xz,
			t.gnzz,
			t.syz,
			t.blfy,
			t.yfyl,
			t.jj,
			t.zysx,
			t.ywhxzy,
			t.ylzy,
			t.zc,
			t.sfmh,
			t.sfmy,
			t.cfhxz,
			t.jzdx,
			t.zyyyt,
			t.rsfnyy,
			t.brqfnyy,
			t.bz,
			decode(t1.ypjcxxzt,'3','2','1','1','2','2','4','4') ypjcxxzt,
			to_char(t.smspzbasj,'YYYY-MM-DD') as pzbarq,
			to_char(t1.update_time,'yyyyMMdd') gxsj,
			t.sjly,
			t.pid,
			t.xglx,
			t.wd_id,
			ROW_NUMBER() over (partition by t.yppzwh,smspzbasj order by t.wd_id desc) rn
		from 
			cjpt_label t 
			left join cjpt_jcsjxx t1 on t.yppzwh = t1.yppzwh
			left join (select wm_concat(t4.fjbclj) smsFjbclj,wm_concat(t4.fjywjm) smsFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'smsWD' group by t3.dxjlid) t2 on t2.dxjlid = t.id
		left join (select wm_concat(t4.fjbclj) bqFjbclj,wm_concat(t4.fjywjm) bqFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'bqWD' group by t3.dxjlid) t3 on t3.dxjlid = t.id
		left join (select  wm_concat(t4.fjbclj) jbFjbclj, wm_concat(t4.fjywjm) jbFjywjm,t3.dxjlid from cjpt_xtfjdxgx t3 
				left join cjpt_xtfj t4 on t3.fjid = t4.id 
				where t4.fjz = 'jbWD' group by t3.dxjlid) t5 on t5.dxjlid = t.id
		left join (select * from 
								(select 
									ROW_NUMBER() over (partition by sc.yppzwh order by sc.update_time desc) rn,
									sc.yppzwh,
									sc.sfym,
									sc.sfzc,
									sc.update_time
									from cjpt_scgyxx sc) t where t.rn = 1) t4 on t.yppzwh = t4.yppzwh
		where t.zt = '2' and t.sjly = '数据对接' and t.wd_id is not null and t.sjzt is null and t.yppzwh not like '%-%' and t.yppzwh not like '%－%'
		) t where rn = 1
	</select>
	
	<select id="queryPushLabelSjdjCount" parameterType="java.util.Map"
		resultType="int">
		select 
			count(distinct t1.id)
		from cjpt_jcsjxx t inner join cjpt_label t1 on t.yppzwh = t1.yppzwh
		where t1.zt = '2' and t1.sjly = '数据对接' and t1.sjzt is null and t.yppzwh not like '%-%' and t.yppzwh not like '%－%'
	</select>
	<!-- 查询定时任务表中的药品批准文号 -->
	<select id="queryLabelTaskYppzwh" resultType="string">
		select wm_concat(yppzwh) from cjpt_label_task
	</select>
</mapper>